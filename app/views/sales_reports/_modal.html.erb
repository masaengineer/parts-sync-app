<dialog class="modal" data-controller="modal" data-modal-target="modal">
  <div class="modal-box max-w-3xl">
    <h3 class="text-lg font-bold text-base-content">
      <%= t('.title') %>: <%= @order.order_number %>
    </h3>

    <div class="divider"></div>

    <div class="py-2">
      <h4 class="font-semibold text-md mb-2 text-base-content"><%= t('.basic_info') %></h4>
      <div class="grid grid-cols-3 gap-3">
        <div class="col-span-2">
          <div class="flex flex-col space-y-1">
            <p class="text-sm font-medium text-base-content"><%= t('.order_number') %>: <%= @order.order_number %></p>
            <p class="text-sm font-medium text-base-content"><%= t('.sale_date') %>: <%= l(@order.sale_date, format: :long) if @order.sale_date %></p>
            <p class="text-sm font-medium text-base-content"><%= t('.tracking_number') %>: <%= @order.shipment&.tracking_number || t('.not_available') %></p>
          </div>

          <% if @order.order_lines.any? %>
            <div class="mt-3">
              <p class="text-sm font-medium text-base-content"><%= t('.products') %>:</p>
              <div class="text-sm pl-2 space-y-1">
                <% @order.order_lines.each do |line| %>
                  <div class="font-medium text-base-content"><%= line.line_item_name %> (x<%= line.quantity %>)</div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="flex items-center justify-center">
          <% if @order.order_lines.any? && @order.order_lines.first.seller_sku %>
            <% image_path = get_product_image_path(@order.order_lines.first.seller_sku) %>
            <% if image_path.present? %>
              <div class="relative group">
                <!-- クリック可能な画像、eBayの注文詳細ページに遷移 -->
                <%= link_to @order.ebay_order_url, target: "_blank", rel: "noopener noreferrer" do %>
                  <%= image_tag(image_path, alt: @order.order_lines.first.line_item_name,
                      class: "w-48 h-48 object-cover rounded shadow-sm border border-primary group-hover:border-primary-focus transition-all cursor-pointer") %>
                  <div class="absolute top-0 right-0 bg-primary text-white text-xs p-1 rounded-bl">
                    <span class="text-xs">eBay</span>
                  </div>
                  <div class="absolute bottom-0 left-0 right-0 bg-base-100/75 text-xs p-1 text-center truncate">
                    <%= @order.order_lines.first.seller_sku.sku_code %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="py-2">
      <h4 class="font-semibold text-md mb-2 text-base-content"><%= t('.financial_details') %></h4>

      <!-- 売上情報 -->
      <div class="mb-4">
        <h5 class="font-medium text-sm mb-2 text-base-content"><%= t('.revenue') %></h5>
        <div class="overflow-x-auto">
          <table class="table table-xs">
            <thead>
              <tr class="text-sm font-medium text-base-content/80">
                <th><%= t('.transaction_type') %></th>
                <th><%= t('.amount') %></th>
                <th><%= t('.transaction_date') %></th>
              </tr>
            </thead>
            <tbody class="font-medium">
              <% @order.sales.each do |sale| %>
                <tr class="<%= sale.transaction_type == 'REFUND' ? 'text-error' : 'text-base-content' %>">
                  <td><%= sale.transaction_type %></td>
                  <td>
                    <%= number_to_currency(sale.order_gross_amount, unit: "$", precision: 2) %>
                    <% if sale.to_usd_rate.present? && sale.to_usd_rate != 1.0 %>
                      (<%= number_to_currency(sale.order_gross_amount * sale.to_usd_rate * 150, unit: "¥", precision: 0) %>)
                    <% end %>
                  </td>
                  <td><%= l(sale.created_at, format: :short) %></td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="font-bold text-base-content">
                <td><%= t('.total') %></td>
                <td colspan="2">
                  <%= number_to_currency(@order.sales.sum(&:order_gross_amount), unit: "$", precision: 2) %>
                  <% if @order.sales.first&.to_usd_rate.present? %>
                    (<%= number_to_currency(@order.sales.sum(&:order_gross_amount) * @order.sales.first.to_usd_rate * 150, unit: "¥", precision: 0) %>)
                  <% end %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- 手数料情報 -->
      <div class="mb-4">
        <h5 class="font-medium text-sm mb-2 text-base-content"><%= t('.fees') %></h5>
        <div class="overflow-x-auto">
          <table class="table table-xs">
            <thead>
              <tr class="text-sm font-medium text-base-content/80">
                <th><%= t('.fee_type') %></th>
                <th><%= t('.category') %></th>
                <th class="text-right"><%= t('.amount') %></th>
                <th><%= t('.fee_date') %></th>
              </tr>
            </thead>
            <tbody class="font-medium">
              <% @order.payment_fees.each do |fee| %>
                <tr class="text-base-content">
                  <td><%= fee.transaction_type %></td>
                  <td><%= fee.fee_category %></td>
                  <td class="text-right <%= fee.fee_amount < 0 ? 'text-error' : '' %>">
                    <%= number_to_currency(fee.fee_amount, unit: "$", precision: 2) %>
                  </td>
                  <td><%= l(@order.sale_date, format: :short) if @order.sale_date %></td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="font-bold text-base-content">
                <td colspan="2"><%= t('.total_fees') %></td>
                <td class="text-right <%= @order.payment_fees.sum(&:fee_amount) < 0 ? 'text-error' : '' %>">
                  <%= number_to_currency(@order.payment_fees.sum(&:fee_amount), unit: "$", precision: 2) %>
                </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- 仕入れコスト情報 -->
      <% if @order.procurement.present? %>
        <div class="mb-4">
          <h5 class="font-medium text-sm mb-2 text-base-content"><%= t('.procurement_costs') %></h5>
          <div class="overflow-x-auto">
            <table class="table table-xs">
              <thead>
                <tr class="text-sm font-medium text-base-content/80">
                  <th><%= t('.cost_type') %></th>
                  <th class="text-right"><%= t('.amount') %></th>
                </tr>
              </thead>
              <tbody class="font-medium text-base-content">
                <tr>
                  <td><%= t('.purchase_price') %></td>
                  <td class="text-right text-error">
                    <%= number_to_currency(@order.procurement.purchase_price, unit: "¥", precision: 0) %>
                  </td>
                </tr>
                <% if @order.procurement.forwarding_fee.present? && @order.procurement.forwarding_fee > 0 %>
                  <tr>
                    <td><%= t('.forwarding_fee') %></td>
                    <td class="text-right text-error">
                      <%= number_to_currency(@order.procurement.forwarding_fee, unit: "¥", precision: 0) %>
                    </td>
                  </tr>
                <% end %>
                <% if @order.procurement.option_fee.present? && @order.procurement.option_fee > 0 %>
                  <tr>
                    <td><%= t('.option_fee') %></td>
                    <td class="text-right text-error">
                      <%= number_to_currency(@order.procurement.option_fee, unit: "¥", precision: 0) %>
                    </td>
                  </tr>
                <% end %>
                <% if @order.procurement.handling_fee.present? && @order.procurement.handling_fee > 0 %>
                  <tr>
                    <td><%= t('.handling_fee') %></td>
                    <td class="text-right text-error">
                      <%= number_to_currency(@order.procurement.handling_fee, unit: "¥", precision: 0) %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot>
                <tr class="font-bold text-base-content">
                  <td><%= t('.total_procurement') %></td>
                  <td class="text-right text-error">
                    <%= number_to_currency(@order.procurement.total_cost, unit: "¥", precision: 0) %>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      <% end %>

      <!-- 送料情報 -->
      <% if @order.shipment.present? %>
        <div class="mb-4">
          <h5 class="font-medium text-sm mb-2 text-base-content"><%= t('.shipping') %></h5>
          <div class="overflow-x-auto">
            <table class="table table-xs">
              <tbody class="font-medium text-base-content">
                <% if @order.shipment.customer_international_shipping.present? && @order.shipment.customer_international_shipping > 0 %>
                  <tr>
                    <td><%= t('.international_shipping') %></td>
                    <td class="text-right text-error">
                      <%= number_to_currency(@order.shipment.customer_international_shipping, unit: "¥", precision: 0) %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <!-- 利益計算 -->
      <div class="mt-6 p-3 bg-base-200 rounded-lg">
        <%
          service = SalesReport::Service.new(@order)
          data = service.calculate
        %>
        <h5 class="font-semibold text-sm mb-2 text-base-content"><%= t('.profit_summary') %></h5>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <p class="text-sm font-medium text-base-content"><%= t('.revenue') %>: <%= number_to_currency(data[:revenue], unit: "$", precision: 2) %></p>
            <p class="text-sm font-medium text-error"><%= t('.fees') %>: <%= number_to_currency(data[:payment_fees], unit: "$", precision: 2) %></p>
            <p class="text-sm font-medium text-base-content"><%= t('.net_revenue') %>: <%= number_to_currency(data[:revenue] - data[:payment_fees], unit: "$", precision: 2) %></p>
            <p class="text-sm font-medium text-base-content"><%= t('.exchange_rate') %>: <%= number_with_precision(data[:exchange_rate], precision: 2) %></p>
          </div>
          <div>
            <p class="text-sm font-medium text-base-content"><%= t('.jpy_revenue') %>: <%= number_to_currency((data[:revenue] - data[:payment_fees]) * 150, unit: "¥", precision: 0) %></p>
            <p class="text-sm font-medium text-error"><%= t('.total_costs') %>: <%= number_to_currency(data[:procurement_cost] + data[:other_costs] + data[:shipping_cost], unit: "¥", precision: 0) %></p>
            <p class="text-sm font-bold text-success"><%= t('.profit') %>: <%= number_to_currency(data[:profit], unit: "¥", precision: 0) %></p>
            <p class="text-sm font-medium text-base-content"><%= t('.profit_rate') %>: <%= number_to_percentage(data[:profit_rate], precision: 2) %></p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn" data-action="click->modal#close"><%= t('.close') %></button>
      </form>
    </div>
  </div>
</dialog>
